#!/usr/bin/env python3
"""
Script zum Erstellen von Test-Bewertungen √ºber die API
"""
import requests
import random
import json
import time
from datetime import datetime, timedelta

# API-Konfiguration
API_BASE_URL = "http://localhost:8000"
REVIEWS_ENDPOINT = f"{API_BASE_URL}/api/reviews"

# Test-Daten
NAMES = [
    "Anna M√ºller", "Max Schmidt", "Lisa Weber", "Tom Fischer", "Sarah Bauer",
    "Felix Wagner", "Emma Richter", "Paul Neumann", "Mia Hoffmann", "Leon Zimmermann",
    "Lena Braun", "Finn Kr√ºger", "Lara Schulz", "Nils K√∂hler", "Julia K√∂nig",
    "Tim Lehmann", "Nina Fuchs", "Jan G√ºnther", "Maya Klein", "Luis Schwarz",
    "Zoe Wei√ü", "Ben Hartmann", "Eva Schr√∂der", "Noah Lange", "Pia Schmitt",
    "Henri Peters", "Lea Hansen", "Elias M√ºller", "Amelie Werner", "Jonas Krause",
    "Sophie Friedrich", "David Meier", "Charlotte Wolf", "Alexander Jung", "Marie Hahn"
]

TITLES = [
    "Fantastische Erfahrung!", "Sehr empfehlenswert", "Top Service!",
    "Absolut begeistert", "Einfach perfekt", "Gro√üartige Qualit√§t",
    "Hervorragender Service", "Wunderbare Atmosph√§re", "Exzellente Betreuung",
    "Traumhaft sch√∂n", "Rundum zufrieden", "Klasse gemacht!", 
    "Sehr professionell", "√úberaus freundlich", "Einfach toll",
    "Mega gut!", "Super Erlebnis", "Wirklich beeindruckend",
    "Kann ich nur empfehlen", "Ausgezeichnet!", "Sehr zufrieden",
    "Tolle Qualit√§t", "Perfekter Service", "Wunderbar!",
    "Excellent choice", "Amazing experience", "Outstanding quality",
    "Brilliant service", "Wonderful time", "Highly recommended",
    "Absolutely fantastic", "Great value", "Perfect execution",
    "Exceptional quality", "Superb experience"
]

COMMENTS = [
    "Ich bin wirklich begeistert von der Qualit√§t und dem Service. Alles hat perfekt geklappt und die Mitarbeiter waren sehr freundlich und hilfsbereit. Kann ich nur weiterempfehlen!",
    "Eine wunderbare Erfahrung! Das Team war professionell und zuvorkommend. Die Qualit√§t hat alle meine Erwartungen √ºbertroffen. Gerne wieder!",
    "Fantastischer Service von Anfang bis Ende. Sehr kompetente Beratung und schnelle Umsetzung. Das Ergebnis spricht f√ºr sich!",
    "Absolute Spitzenklasse! Hier stimmt einfach alles - von der Beratung √ºber die Ausf√ºhrung bis hin zum Endergebnis. Vielen Dank!",
    "Ich war zun√§chst skeptisch, aber alle Zweifel wurden schnell ausger√§umt. Hervorragende Arbeit und faire Preise. Sehr zu empfehlen!",
    "Ein tolles Team mit viel Erfahrung und Kompetenz. Die Zusammenarbeit war unkompliziert und das Ergebnis einfach perfekt.",
    "Super zufrieden mit allem! Schnelle Bearbeitung, faire Preise und ein Ergebnis, das meine Erwartungen √ºbertroffen hat.",
    "Professionell, freundlich und zuverl√§ssig. Genau so stellt man sich guten Service vor. Kann ich uneingeschr√§nkt empfehlen!",
    "Die Qualit√§t ist wirklich herausragend. Man merkt, dass hier mit Leidenschaft und Expertise gearbeitet wird. Toll gemacht!",
    "Von der ersten Beratung bis zur finalen Umsetzung - alles perfekt! Das Team ist kompetent und sehr kundenorientiert.",
    "Ich bin rundum begeistert! Schnelle Abwicklung, top Qualit√§t und ein sehr fairer Preis. Was will man mehr?",
    "Excellent service and outstanding quality! The team was very professional and delivered exactly what was promised.",
    "Amazing experience from start to finish. Great communication, timely delivery, and superb results. Highly recommended!",
    "The attention to detail is remarkable. Every aspect was handled with care and precision. Absolutely fantastic work!",
    "Outstanding professionalism and quality. The team exceeded all expectations and delivered exceptional results.",
    "Brilliant work and excellent customer service. Everything was handled smoothly and efficiently. Very impressed!",
    "Top-notch quality and service. The team was knowledgeable, friendly, and delivered exactly what we needed.",
    "Incredible attention to detail and superior craftsmanship. The final result is absolutely perfect!",
    "Exceptional quality and outstanding customer service. The entire process was smooth and professional.",
    "Amazing team with great expertise! They delivered beyond expectations and the quality is simply outstanding.",
    "Sehr gute Erfahrung gemacht. Das Team ist kompetent und arbeitet sehr sorgf√§ltig. Das Ergebnis kann sich sehen lassen!",
    "Bin mit der Qualit√§t sehr zufrieden. Alles wurde wie versprochen umgesetzt und der Service war erstklassig.",
    "Tolle Arbeit! Von der Planung bis zur Umsetzung lief alles reibungslos. Sehr empfehlenswert!",
    "Das Team hat wirklich gute Arbeit geleistet. Alles wurde termingerecht und in hoher Qualit√§t abgeliefert.",
    "Sehr professionelle Herangehensweise und exzellente Umsetzung. Bin mit dem Ergebnis mehr als zufrieden!",
    "Kompetente Beratung und hervorragende Ausf√ºhrung. Das Preis-Leistungs-Verh√§ltnis stimmt absolut.",
    "Ein wirklich tolles Erlebnis! Das Team war sehr freundlich und hat hervorragende Arbeit geleistet.",
    "Alles hat perfekt geklappt. Schnelle Bearbeitung, faire Preise und ein Ergebnis, das √ºberzeugt!",
    "Sehr zufrieden mit der gesamten Abwicklung. Professionell, zuverl√§ssig und qualitativ hochwertig.",
    "Die Zusammenarbeit war unkompliziert und das Endergebnis ist einfach perfekt. Gerne wieder!",
    "Top Service und herausragende Qualit√§t. Kann ich jedem w√§rmstens empfehlen!",
    "Das Team hat alle Erwartungen √ºbertroffen. Sehr professionell und kundenorientiert.",
    "Exzellente Beratung und perfekte Umsetzung. Bin rundum begeistert vom Ergebnis!",
    "Wunderbare Erfahrung! Alles wurde wie besprochen umgesetzt und die Qualit√§t ist erstklassig.",
    "Sehr empfehlenswert! Kompetentes Team, faire Preise und hervorragende Qualit√§t."
]

EMAILS = [
    "anna.mueller@email.com", "max.schmidt@test.de", "lisa.weber@mail.com",
    "tom.fischer@example.org", "sarah.bauer@web.de", "felix.wagner@gmail.com",
    "emma.richter@yahoo.de", "paul.neumann@hotmail.com", "mia.hoffmann@outlook.de",
    "leon.zimmermann@gmx.de", "lena.braun@t-online.de", "finn.krueger@freenet.de",
    "lara.schulz@posteo.de", "nils.koehler@tutanota.com", "julia.koenig@protonmail.com",
    "tim.lehmann@mailbox.org", "nina.fuchs@web.de", "jan.guenther@gmail.com",
    "maya.klein@yahoo.com", "luis.schwarz@hotmail.de", "zoe.weiss@outlook.com",
    "ben.hartmann@gmx.at", "eva.schroeder@mail.at", "noah.lange@email.at",
    "pia.schmitt@live.de", "henri.peters@icloud.com", "lea.hansen@me.com",
    "elias.mueller@aol.com", "amelie.werner@zoho.com", "jonas.krause@yandex.com",
    "sophie.friedrich@fastmail.com", "david.meier@rocketmail.com", 
    "charlotte.wolf@mail.ru", "alexander.jung@inbox.com", "marie.hahn@rediffmail.com"
]

def create_test_review(index):
    """Erstellt eine Test-Bewertung"""
    
    # Zuf√§llige Daten ausw√§hlen
    name = NAMES[index % len(NAMES)]
    email = EMAILS[index % len(EMAILS)] if random.choice([True, False, True]) else None  # 2/3 haben E-Mail
    rating = random.choices([1, 2, 3, 4, 5], weights=[1, 2, 5, 15, 25])[0]  # Mehr hohe Bewertungen
    title = random.choice(TITLES) if random.choice([True, False]) else None  # 50% haben Titel
    content = COMMENTS[index % len(COMMENTS)]
    
    review_data = {
        "name": name,
        "rating": rating,
        "content": content
    }
    
    if email:
        review_data["email"] = email
    if title:
        review_data["title"] = title
    
    return review_data

def create_reviews():
    """Erstellt 35 Test-Bewertungen mit Pausen zwischen den Anfragen"""
    print("üöÄ Erstelle 35 Test-Bewertungen (mit Pausen f√ºr Rate-Limiting)...")
    print("-" * 60)
    
    success_count = 0
    error_count = 0
    rate_limited_count = 0
    
    for i in range(35):
        try:
            review_data = create_test_review(i)
            
            response = requests.post(
                REVIEWS_ENDPOINT,
                json=review_data,
                headers={"Content-Type": "application/json"},
                timeout=10
            )
            
            if response.status_code == 200:
                result = response.json()
                success_count += 1
                print(f"‚úÖ Review {i+1:2d}: {review_data['name']} - {review_data['rating']}‚≠ê")
                # Kurze Pause zwischen erfolgreichen Anfragen
                time.sleep(0.5)
                
            elif response.status_code == 429:
                rate_limited_count += 1
                print(f"‚è≥ Review {i+1:2d}: Rate-Limit erreicht - warte 65 Sekunden...")
                time.sleep(65)  # Warte etwas mehr als 1 Minute
                
                # Nochmal versuchen
                response = requests.post(
                    REVIEWS_ENDPOINT,
                    json=review_data,
                    headers={"Content-Type": "application/json"},
                    timeout=10
                )
                
                if response.status_code == 200:
                    result = response.json()
                    success_count += 1
                    print(f"‚úÖ Review {i+1:2d}: {review_data['name']} - {review_data['rating']}‚≠ê (nach Wartezeit)")
                    time.sleep(0.5)
                else:
                    error_count += 1
                    print(f"‚ùå Review {i+1:2d}: Immer noch Fehler {response.status_code}")
            else:
                error_count += 1
                print(f"‚ùå Review {i+1:2d}: Fehler {response.status_code} - {response.text[:100]}")
                
        except requests.exceptions.RequestException as e:
            error_count += 1
            print(f"‚ùå Review {i+1:2d}: Verbindungsfehler - {str(e)[:100]}")
        except Exception as e:
            error_count += 1
            print(f"‚ùå Review {i+1:2d}: Unbekannter Fehler - {str(e)[:100]}")
    
    print("-" * 60)
    print(f"‚úÖ Erfolgreich erstellt: {success_count}")
    print(f"‚è≥ Rate-Limit erreicht: {rate_limited_count} mal")
    print(f"‚ùå Fehler: {error_count}")
    print(f"üìä Gesamt: {success_count + error_count}")
    
    if success_count > 0:
        print(f"\nüéâ {success_count} Test-Bewertungen wurden erfolgreich erstellt!")
        print(f"üì± Frontend: http://localhost:3000")
        print(f"üîß API: {REVIEWS_ENDPOINT}")

if __name__ == "__main__":
    try:
        # Zuerst testen ob die API erreichbar ist
        response = requests.get(f"{API_BASE_URL}/api/reviews", timeout=5)
        if response.status_code == 200:
            print("‚úÖ API ist erreichbar")
            create_reviews()
        else:
            print(f"‚ùå API antwortet mit Status {response.status_code}")
    except requests.exceptions.RequestException as e:
        print(f"‚ùå Kann API nicht erreichen: {e}")
        print("üí° Stelle sicher, dass das Backend l√§uft: docker-compose up -d")
